<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head}"></head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>
<main class="container my-5">
    <h1 class="mb-4">Checkout</h1>
    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-3">
                <div class="card-body">
                    <h5>Order Summary</h5>
                    <ul id="orderSummary" class="list-group list-group-flush"></ul>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <h5>Payment Simulation</h5>
                    <div id="checkoutAlert" class="alert alert-danger d-none"></div>
                    <form id="checkoutForm" class="needs-validation" novalidate>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label" for="customerEmail">Contact Email</label>
                                <input class="form-control" id="customerEmail" name="customerEmail" type="email" placeholder="you@example.com" required>
                                <div class="invalid-feedback" data-field-feedback="customerEmail"></div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label" for="customerPhone">Phone (optional)</label>
                                <input class="form-control" id="customerPhone" name="customerPhone" placeholder="+48123456789">
                                <div class="invalid-feedback" data-field-feedback="customerPhone"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="cardholderName">Name on Card</label>
                            <input class="form-control" id="cardholderName" name="cardholderName" placeholder="John Doe" required>
                            <div class="invalid-feedback" data-field-feedback="cardholderName"></div>
                        </div>
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label class="form-label">Card Number</label>
                                <input class="form-control" placeholder="4111 1111 1111 1111" disabled>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">Expiry</label>
                                <input class="form-control" placeholder="12/28" disabled>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">CVV</label>
                                <input class="form-control" placeholder="123" disabled>
                            </div>
                        </div>
                        <div class="d-grid">
                            <button id="payBtn" class="btn btn-cinema" type="submit">Pay & Confirm</button>
                        </div>
                    </form>
                    <div id="confirmation" class="alert alert-success mt-3 d-none"></div>
                    <div id="qrContainer" class="text-center d-none">
                        <img id="qrImage" class="img-fluid mb-2" alt="Ticket QR">
                        <div>
                            <a id="qrDownload" class="btn btn-outline-secondary btn-sm" download>Download QR</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-body">
                    <h5>Total</h5>
                    <p class="display-6" id="totalDisplay">0.00</p>
                </div>
            </div>
        </div>
    </div>
</main>
<div th:replace="~{fragments/footer :: footer}"></div>
<script>
(() => {
    const screeningId = localStorage.getItem('currentScreeningId');
    const orderSummaryEl = document.getElementById('orderSummary');
    const totalDisplayEl = document.getElementById('totalDisplay');
    const checkoutForm = document.getElementById('checkoutForm');
    const confirmationEl = document.getElementById('confirmation');
    const alertEl = document.getElementById('checkoutAlert');
    const qrContainer = document.getElementById('qrContainer');
    const qrImage = document.getElementById('qrImage');
    const qrDownload = document.getElementById('qrDownload');
    const payBtn = document.getElementById('payBtn');
    const feedback = window.AppFeedback || null;
    let cartState = { items: [] };

    document.addEventListener('DOMContentLoaded', async () => {
        if (!screeningId) {
            showAlert('No screening selected. Return to seat selection to start checkout.');
            disableCheckout();
            return;
        }
        await loadCart();
        checkoutForm.addEventListener('submit', submitCheckout);
    });

    async function loadCart() {
        try {
            const res = await fetch(`/api/v1/screenings/${screeningId}/cart`);
            if (!res.ok) throw new Error('Unable to load cart');
            cartState = await res.json();
            renderOrder();
        } catch (error) {
            console.error('Checkout cart load failed', error);
            cartState = { items: [] };
            renderOrder();
            showAlert('We could not load your cart. Please refresh the page.');
        }
    }

    function renderOrder() {
        const items = cartState.items || [];
        if (!items.length) {
            orderSummaryEl.innerHTML = '<li class="list-group-item text-muted">Cart is empty</li>';
            totalDisplayEl.textContent = '0.00';
            disableCheckout();
            return;
        }

        orderSummaryEl.innerHTML = items.map(item => `
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>Row ${item.rowNumber}, Seat ${item.seatNumber} - ${formatTicket(item.ticketType)}</span>
                <span>${formatPrice(item.price)}</span>
            </li>
        `).join('');
        totalDisplayEl.textContent = formatPrice(cartState.subtotal);
        enableCheckout();
    }

    async function submitCheckout(event) {
        event.preventDefault();
        if (!cartState.items || !cartState.items.length) {
            showAlert('Your cart is empty.');
            return;
        }
        feedback?.clearFieldErrors?.(checkoutForm);
        hideAlert();
        const payload = {
            customerEmail: checkoutForm.customerEmail.value,
            customerPhone: checkoutForm.customerPhone.value,
            cardholderName: checkoutForm.cardholderName.value,
            paymentMethod: 'CARD'
        };
        const clientErrors = validatePayload(payload);
        if (Object.keys(clientErrors).length) {
            feedback?.setFieldErrors?.(checkoutForm, clientErrors);
            showAlert('Please correct the highlighted fields before continuing.', clientErrors);
            feedback?.warning?.('Fix required fields', 'Double-check the highlighted inputs.');
            return;
        }
        try {
            payBtn.disabled = true;
            payBtn.textContent = 'Processing...';
            const res = await fetch(`/api/v1/screenings/${screeningId}/checkout`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (res.status === 401) {
                throw new Error('Please log in to finish checkout.');
            }
            if (!res.ok) {
                const detail = await parseApiError(res, 'Checkout failed');
                throw detail;
            }
            const data = await res.json();
            displayConfirmation(data);
            feedback?.success?.('Checkout confirmed', `Booking ${data.bookingNumber} has been secured.`);
        } catch (error) {
            console.error('Checkout failed', error);
            if (error.errors && feedback?.setFieldErrors) {
                feedback.setFieldErrors(checkoutForm, error.errors);
            }
            showAlert(error.message || 'Payment failed. Please try again.', error.errors);
            if (!error.errors) {
                feedback?.error?.('Checkout failed', error.message || 'Something went wrong.');
            }
        } finally {
            payBtn.disabled = false;
            payBtn.textContent = 'Pay & Confirm';
        }
    }

    function validatePayload(payload) {
        const errors = {};
        if (!payload.customerEmail || !payload.customerEmail.trim()) {
            errors.customerEmail = 'Customer email is required';
        } else if (!isValidEmail(payload.customerEmail)) {
            errors.customerEmail = 'Customer email must be valid';
        }
        if (!payload.cardholderName || !payload.cardholderName.trim()) {
            errors.cardholderName = 'Cardholder name is required';
        }
        if (!payload.paymentMethod) {
            errors.paymentMethod = 'Payment method is required';
        }
        return errors;
    }

    function isValidEmail(value) {
        const pattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return pattern.test(value.trim());
    }

    function displayConfirmation(data) {
        confirmationEl.textContent = `Payment successful. Booking ${data.bookingNumber} confirmed.`;
        confirmationEl.classList.remove('d-none');
        hideAlert();
        renderQr(data);
        cartState = { items: [] };
        orderSummaryEl.innerHTML = '<li class="list-group-item text-muted">All seats confirmed</li>';
        totalDisplayEl.textContent = '0.00';
        disableCheckout();
    }

    function renderQr(data) {
        if (!data.qrCodeImage) {
            qrContainer.classList.add('d-none');
            return;
        }
        const src = `data:image/png;base64,${data.qrCodeImage}`;
        qrImage.src = src;
        qrImage.alt = `Ticket QR ${data.bookingNumber}`;
        qrDownload.href = src;
        qrDownload.download = `${data.bookingNumber || 'ticket'}.png`;
        qrContainer.classList.remove('d-none');
    }

    function formatTicket(name) {
        return name?.toString().replace('_', ' ') || 'Ticket';
    }

    function formatPrice(value) {
        return (Number(value) || 0).toFixed(2);
    }

    function showAlert(message, validationErrors = null) {
        if (!alertEl) return;
        alertEl.replaceChildren();
        const summary = document.createElement('div');
        summary.textContent = message;
        alertEl.appendChild(summary);
        if (validationErrors && Object.keys(validationErrors).length) {
            const list = document.createElement('ul');
            list.className = 'mb-0 mt-2 small';
            Object.entries(validationErrors).forEach(([field, msg]) => {
                const item = document.createElement('li');
                item.textContent = `${formatField(field)}: ${msg}`;
                list.appendChild(item);
            });
            alertEl.appendChild(list);
        }
        alertEl.classList.remove('d-none');
    }

    function hideAlert() {
        if (!alertEl) return;
        alertEl.replaceChildren();
        alertEl.classList.add('d-none');
    }

    function disableCheckout() {
        payBtn.disabled = true;
    }

    function enableCheckout() {
        payBtn.disabled = false;
        hideAlert();
    }

    async function parseApiError(response, fallbackMessage) {
        if (feedback?.parseErrorResponse) {
            const detail = await feedback.parseErrorResponse(response);
            if (feedback?.createError) {
                return feedback.createError(detail);
            }
            const err = new Error(detail.message || fallbackMessage);
            err.errors = detail.errors;
            return err;
        }
        const text = await response.text();
        return new Error(text || fallbackMessage);
    }

    function formatField(field) {
        if (!field) return 'Field';
        return field
            .replace(/([A-Z])/g, ' $1')
            .replace(/[_-]+/g, ' ')
            .replace(/^./, ch => ch.toUpperCase());
    }
})();
</script>
</body>
</html>
