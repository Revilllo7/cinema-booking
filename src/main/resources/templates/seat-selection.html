<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head}"></head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>
<main class="container my-5">
    <h1 class="mb-4">Select Your Seats</h1>
    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="screen-label">SCREEN</div>
            <div id="seatMap" class="seat-map"></div>
            <div class="mt-3 seat-legend">
                <span><span class="seat seat-free"></span> Free</span>
                <span><span class="seat seat-selected"></span> Selected</span>
                <span><span class="seat seat-held"></span> Held (10 min)</span>
                <span><span class="seat seat-sold"></span> Sold</span>
            </div>
            <div id="seatErrors" class="alert alert-danger mt-3 d-none"></div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-body">
                    <h5>Your Selection</h5>
                    <ul id="selectedSeats" class="list-group list-group-flush mb-3"></ul>
                    <div class="d-grid gap-2">
                        <a class="btn btn-cinema" href="/cart">Go to Cart</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
<div th:replace="~{fragments/footer :: footer}"></div>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2/dist/stomp.min.js"></script>
<script>
(() => {
    const seatMapEl = document.getElementById('seatMap');
    const selectedSeatsEl = document.getElementById('selectedSeats');
    const seatErrorsEl = document.getElementById('seatErrors');
    const screeningId = new URLSearchParams(window.location.search).get('screeningId');
    const storedScreeningId = localStorage.getItem('currentScreeningId');
    const seats = new Map();
    let cartState = { items: [] };
    let ticketOptions = [];
    let defaultTicketTypeId = null;
    let rows = 0;
    let cols = 0;
    let holdMinutes = 10;
    let stompClient = null;

    if (!screeningId) {
        seatMapEl.innerHTML = '<div class="alert alert-warning">No screening selected. Please go back and choose a screening.</div>';
        return;
    }

    if (storedScreeningId && storedScreeningId !== screeningId) {
        localStorage.removeItem('currentScreeningId');
    }
    localStorage.setItem('currentScreeningId', screeningId);

    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
            loadSeatMap();
            loadCart();
        }
    });

    // NOTE: Seat locks persist for 10 minutes and will auto-expire.
    // Do NOT release locks on page unload - they need to survive navigation to cart/checkout pages.

    init();
    
    // Update countdown timers every second so user sees real-time expiration
    setInterval(renderSelectionList, 1000);

    async function init() {
        await loadTicketOptions();
        await loadSeatMap();
        await loadCart();
        connectSocket();
        setInterval(renderSelectionList, 1000);
        // Periodically refresh seat map to catch expirations and other users' bookings (fallback for WebSocket)
        setInterval(loadSeatMap, 5000);
    }

    async function loadTicketOptions() {
        try {
            const res = await fetch(`/api/v1/screenings/${screeningId}/cart/ticket-options`);
            if (!res.ok) return;
            ticketOptions = await res.json();
            defaultTicketTypeId = (ticketOptions.find(opt => opt.name === 'STANDARD') || ticketOptions[0])?.ticketTypeId || null;
        } catch (error) {
            console.warn('Unable to load ticket types', error);
        }
    }

    async function loadSeatMap() {
        try {
            const res = await fetch(`/api/v1/screenings/${screeningId}/seats`);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            rows = data.rows;
            cols = data.cols;
            holdMinutes = data.holdMinutes ?? holdMinutes;
            seats.clear();
            (data.seats || []).forEach(dto => {
                seats.set(dto.seatId, {
                    seatId: dto.seatId,
                    rowNumber: dto.rowNumber,
                    seatNumber: dto.seatNumber,
                    status: dto.status,
                    selectedByYou: dto.selectedByYou,
                    lockExpiresAt: dto.lockExpiresAt ? Date.parse(dto.lockExpiresAt) : null
                });
            });
            renderSeatMap();
            renderSelectionList();
            clearError();
        } catch (error) {
            console.error('Failed to load seat map', error);
            seatMapEl.innerHTML = '<div class="alert alert-danger">Unable to load seat map. Please refresh.</div>';
            showError('Unable to load seat map. Please refresh the page.');
        }
    }

    async function loadCart() {
        try {
            const res = await fetch(`/api/v1/screenings/${screeningId}/cart`);
            if (!res.ok) throw new Error('Unable to load cart');
            cartState = await res.json();
            renderSelectionList();
        } catch (error) {
            console.warn('Cart unavailable', error);
            cartState = { items: [] };
            renderSelectionList();
        }
    }

    function renderSeatMap() {
        seatMapEl.innerHTML = '';
        for (let r = 1; r <= rows; r++) {
            const rowEl = document.createElement('div');
            rowEl.className = 'seat-row';
            const rowSeats = Array.from(seats.values())
                .filter(seat => seat.rowNumber === r)
                .sort((a, b) => a.seatNumber - b.seatNumber);
            rowSeats.forEach(seat => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = `seat ${seatClassFor(seat)}`;
                btn.textContent = seat.seatNumber;
                btn.title = `Row ${seat.rowNumber}, Seat ${seat.seatNumber}`;
                btn.disabled = seat.status !== 'FREE' && !seat.selectedByYou;
                btn.onclick = () => handleSeatClick(seat);
                rowEl.appendChild(btn);
            });
            seatMapEl.appendChild(rowEl);
        }
    }

    function seatClassFor(seat) {
        if (seat.selectedByYou) return 'seat-selected';
        if (seat.status === 'FREE') return 'seat-free';
        if (seat.status === 'SOLD') return 'seat-sold';
        return 'seat-held';
    }

    function renderSelectionList() {
        const items = cartState.items || [];
        if (!items.length) {
            selectedSeatsEl.innerHTML = '<li class="list-group-item text-muted">No seats selected</li>';
            return;
        }

        selectedSeatsEl.innerHTML = items.map(item => {
            const label = `Row ${item.rowNumber}, Seat ${item.seatNumber}`;
            return `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <div>${label}</div>
                        <small class="text-muted">Hold expires ${formatCountdown(item.lockExpiresAt)}</small>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" data-seat-id="${item.seatId}">Remove</button>
                </li>
            `;
        }).join('');

        selectedSeatsEl.querySelectorAll('button[data-seat-id]').forEach(btn => {
            btn.addEventListener('click', () => releaseSeat(Number(btn.dataset.seatId)));
        });
    }

    function formatCountdown(timestamp) {
        if (!timestamp) return 'soon';
        const expiresAt = Date.parse(timestamp);
        const delta = expiresAt - Date.now();
        if (Number.isNaN(expiresAt) || delta <= 0) return 'soon';
        const minutes = Math.floor(delta / 60000);
        const seconds = Math.floor((delta % 60000) / 1000);
        return `in ${minutes}m ${seconds.toString().padStart(2, '0')}s`;
    }

    async function handleSeatClick(seat) {
        if (seat.selectedByYou) {
            await releaseSeat(seat.seatId);
            return;
        }
        if (seat.status !== 'FREE') {
            return;
        }
        await lockSeat(seat.seatId);
    }

    async function lockSeat(seatId) {
        try {
            const res = await fetch(`/api/v1/screenings/${screeningId}/locks`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ seatId })
            });
            if (!res.ok) {
                const error = await res.json();
                if (res.status === 400 && error.message.includes('already locked')) {
                    // Seat locked by another user - refresh seat map to show updated state
                    console.debug('Seat locked by another user, refreshing map');
                    await loadSeatMap();
                    clearError();
                } else {
                    throw new Error(error.message || 'Failed to lock seat');
                }
                return;
            }
            const dto = await res.json();
            seats.set(dto.seatId, {
                seatId: dto.seatId,
                rowNumber: dto.rowNumber,
                seatNumber: dto.seatNumber,
                status: dto.status,
                selectedByYou: dto.selectedByYou,
                lockExpiresAt: dto.lockExpiresAt ? Date.parse(dto.lockExpiresAt) : null
            });
            await syncCartAdd(dto.seatId);
            renderSeatMap();
            renderSelectionList();
            clearError();
        } catch (error) {
            console.error('Failed to lock seat', error);
            showError(error.message || 'Seat is no longer available.');
        }
    }

    async function syncCartAdd(seatId) {
        if (!defaultTicketTypeId) {
            throw new Error('Ticket options unavailable. Please refresh.');
        }
        const res = await fetch(`/api/v1/screenings/${screeningId}/cart`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ seatId, ticketTypeId: defaultTicketTypeId })
        });
        if (!res.ok) {
            throw new Error(await res.text());
        }
        cartState = await res.json();
    }

    async function releaseSeat(seatId) {
        try {
            const res = await fetch(`/api/v1/screenings/${screeningId}/locks/${seatId}`, { method: 'DELETE' });
            if (!res.ok) throw new Error(await res.text());
            await syncCartRemove(seatId);
            await loadSeatMap();
        } catch (error) {
            console.error('Failed to release seat', error);
        }
    }

    async function syncCartRemove(seatId) {
        try {
            const res = await fetch(`/api/v1/screenings/${screeningId}/cart/${seatId}`, { method: 'DELETE' });
            if (!res.ok) throw new Error(await res.text());
            cartState = await res.json();
            renderSelectionList();
        } catch (error) {
            console.warn('Failed to remove seat from cart', error);
        }
    }

    function connectSocket() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, () => {
            stompClient.subscribe(`/topic/screenings/${screeningId}/seats`, message => {
                try {
                    const payload = JSON.parse(message.body);
                    applyBroadcast(payload);
                } catch (error) {
                    console.error('Invalid seat update payload', error);
                }
            });
        });
    }

    function applyBroadcast(payload) {
        let shouldRefreshCart = false;
        (payload || []).forEach(dto => {
            const inCart = (cartState.items || []).some(item => item.seatId === dto.seatId);
            // Check if seat status changed from FREE to BOOKED (locked by another user)
            const seatBefore = seats.get(dto.seatId);
            const seatLockedByOther = dto.status !== 'FREE' && !inCart && seatBefore && seatBefore.status === 'FREE';
            
            if (inCart && dto.status === 'FREE') {
                shouldRefreshCart = true;
            }
            if (seatLockedByOther) {
                console.debug(`Seat ${dto.seatId} locked by another user`);
            }
            seats.set(dto.seatId, {
                seatId: dto.seatId,
                rowNumber: dto.rowNumber,
                seatNumber: dto.seatNumber,
                status: dto.status,
                selectedByYou: inCart && dto.status !== 'FREE',
                lockExpiresAt: dto.lockExpiresAt ? Date.parse(dto.lockExpiresAt) : null
            });
        });
        if (shouldRefreshCart) {
            loadCart();
        }
        renderSeatMap();
    }

    function showError(message) {
        seatErrorsEl.textContent = message;
        seatErrorsEl.classList.remove('d-none');
    }

    function clearError() {
        seatErrorsEl.textContent = '';
        seatErrorsEl.classList.add('d-none');
    }
})();
</script>
</body>
</html>
