<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/head :: head}"></head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>
<main class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <div>
            <h2><i class="bi bi-ticket-perforated"></i> Manage Bookings</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="/admin" th:href="@{/admin}">Admin Dashboard</a></li>
                    <li class="breadcrumb-item active">Bookings</li>
                </ol>
            </nav>
        </div>
        <button class="btn btn-outline-secondary" onclick="loadBookings()">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
    </div>

    <div class="row g-3 mb-4" id="summaryCards">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <p class="text-muted mb-1">Total Bookings</p>
                    <h3 class="text-cinema-primary" id="summaryTotal">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <p class="text-muted mb-1">Confirmed</p>
                    <h3 class="text-success" id="summaryConfirmed">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <p class="text-muted mb-1">Pending</p>
                    <h3 class="text-warning" id="summaryPending">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <p class="text-muted mb-1">Current Month Revenue</p>
                    <h3 class="text-cinema-primary" id="summaryRevenue">$0.00</h3>
                    <small class="text-muted" id="summaryTickets">0 tickets</small>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Search</label>
                    <input type="text" id="searchInput" class="form-control" placeholder="Booking #, customer, movie...">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Status</label>
                    <select id="statusFilter" class="form-select">
                        <option value="">All statuses</option>
                        <option value="CONFIRMED">Confirmed</option>
                        <option value="PENDING">Pending</option>
                        <option value="CANCELLED">Cancelled</option>
                        <option value="EXPIRED">Expired</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">From</label>
                    <input type="date" id="startDateFilter" class="form-control">
                </div>
                <div class="col-md-2">
                    <label class="form-label">To</label>
                    <input type="date" id="endDateFilter" class="form-control">
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button class="btn btn-cinema w-100" onclick="loadBookings(0)">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-cinema-primary text-white d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h5 class="mb-0"><i class="bi bi-table"></i> Booking List</h5>
            <div>
                <select id="sortSelect" class="form-select form-select-sm" onchange="changeSort()">
                    <option value="createdAt,DESC">Newest first</option>
                    <option value="createdAt,ASC">Oldest first</option>
                    <option value="totalPrice,DESC">Price high → low</option>
                    <option value="totalPrice,ASC">Price low → high</option>
                    <option value="screeningStartTime,ASC">Screening date</option>
                </select>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover admin-table mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Customer</th>
                            <th>Movie</th>
                            <th>Screening</th>
                            <th>Seats</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Payment</th>
                        </tr>
                    </thead>
                    <tbody id="bookingsTableBody">
                        <tr>
                            <td colspan="9" class="text-center py-4">
                                <div class="spinner-border text-primary" role="status"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer">
            <nav id="paginationNav"></nav>
        </div>
    </div>
</main>
<div th:replace="~{fragments/footer :: footer}"></div>
<script>
    let currentPage = 0;
    let pageSize = 15;
    let sortField = 'createdAt';
    let sortDirection = 'DESC';

    async function loadSummary() {
        try {
            const response = await fetch('/api/v1/admin/bookings/summary');
            if (!response.ok) throw new Error('Failed to load summary');
            const summary = await response.json();
            document.getElementById('summaryTotal').textContent = summary.totalBookings ?? '-';
            document.getElementById('summaryConfirmed').textContent = summary.confirmedBookings ?? '-';
            document.getElementById('summaryPending').textContent = summary.pendingBookings ?? '-';
            document.getElementById('summaryRevenue').textContent = `$${(summary.currentMonthRevenue || 0).toFixed(2)}`;
            document.getElementById('summaryTickets').textContent = `${summary.currentMonthTickets || 0} tickets`;
        } catch (error) {
            console.error(error);
            document.getElementById('summaryCards').classList.add('opacity-50');
        }
    }

    async function loadBookings(page = 0) {
        currentPage = page;
        const status = document.getElementById('statusFilter').value;
        const search = document.getElementById('searchInput').value;
        const startDate = document.getElementById('startDateFilter').value;
        const endDate = document.getElementById('endDateFilter').value;

        const params = new URLSearchParams({
            page: page,
            size: pageSize,
            sortBy: sortField,
            direction: sortDirection
        });
        if (status) params.append('status', status);
        if (search) params.append('search', search.trim());
        if (startDate) params.append('startDate', startDate);
        if (endDate) params.append('endDate', endDate);

        try {
            const response = await fetch(`/api/v1/admin/bookings?${params.toString()}`);
            if (!response.ok) throw new Error('Failed to load bookings');
            const pageData = await response.json();
            renderTable(pageData.content);
            renderPagination(pageData);
        } catch (error) {
            console.error(error);
            document.getElementById('bookingsTableBody').innerHTML =
                '<tr><td colspan="9" class="text-center text-danger py-4">Unable to load bookings.</td></tr>';
        }
    }

    function renderTable(bookings) {
        const tbody = document.getElementById('bookingsTableBody');
        if (!bookings.length) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-muted">No bookings match your filters.</td></tr>';
            return;
        }
        tbody.innerHTML = bookings.map(booking => {
            const seatBadge = `<span class="badge bg-info">${booking.seatsCount || 0}</span>`;
            return `
                <tr>
                    <td><strong>${booking.bookingNumber}</strong><br><small>ID ${booking.id}</small></td>
                    <td>
                        <div>${booking.username || 'N/A'}</div>
                        <small class="text-muted">${booking.userEmail || booking.customerEmail || ''}</small>
                    </td>
                    <td>${booking.movieTitle || '—'}</td>
                    <td>
                        <div>${formatDateTime(booking.screeningStartTime)}</div>
                        <small class="text-muted">${booking.hallName || ''}</small>
                    </td>
                    <td>${seatBadge}</td>
                    <td><strong>$${(booking.totalPrice || 0).toFixed(2)}</strong></td>
                    <td>${buildStatusBadge(booking.status)}</td>
                    <td>${formatDateTime(booking.createdAt)}</td>
                    <td>
                        <div>${booking.paymentMethod || '—'}</div>
                        <small class="text-muted">${booking.customerPhone || ''}</small>
                    </td>
                </tr>`;
        }).join('');
    }

    function buildStatusBadge(status) {
        if (!status) return '<span class="badge bg-secondary">Unknown</span>';
        const mapping = {
            CONFIRMED: 'success',
            PENDING: 'warning',
            CANCELLED: 'secondary',
            EXPIRED: 'dark'
        };
        const theme = mapping[status] || 'info';
        return `<span class="badge bg-${theme}">${status}</span>`;
    }

    function formatDateTime(value) {
        if (!value) return '—';
        const date = new Date(value);
        return date.toLocaleString(undefined, {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function renderPagination(data) {
        const nav = document.getElementById('paginationNav');
        if (!data || data.totalPages <= 1) {
            nav.innerHTML = '';
            return;
        }
        let html = '<ul class="pagination pagination-sm mb-0 justify-content-center">';
        html += `<li class="page-item ${data.first ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadBookings(${currentPage - 1}); return false;">Previous</a>
                 </li>`;
        for (let i = 0; i < data.totalPages; i++) {
            if (i === 0 || i === data.totalPages - 1 || Math.abs(i - currentPage) <= 2) {
                html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="loadBookings(${i}); return false;">${i + 1}</a>
                        </li>`;
            } else if (Math.abs(i - currentPage) === 3) {
                html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
        }
        html += `<li class="page-item ${data.last ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadBookings(${currentPage + 1}); return false;">Next</a>
                 </li>`;
        html += '</ul>';
        nav.innerHTML = html;
    }

    function changeSort() {
        const [field, direction] = document.getElementById('sortSelect').value.split(',');
        sortField = field;
        sortDirection = direction;
        loadBookings(0);
    }

    document.getElementById('searchInput').addEventListener('keyup', (event) => {
        if (event.key === 'Enter') {
            loadBookings(0);
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        loadSummary();
        loadBookings();
    });
</script>
</body>
</html>
