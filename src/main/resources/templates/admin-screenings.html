<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/head :: head}"></head>
<body>
    <div th:replace="~{fragments/navbar :: navbar}"></div>
    
    <main class="container my-5">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="bi bi-camera-reels"></i> Manage Screenings</h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/admin" th:href="@{/admin}">Admin Dashboard</a></li>
                        <li class="breadcrumb-item active">Screenings</li>
                    </ol>
                </nav>
            </div>
            <button class="btn btn-cinema" data-bs-toggle="modal" data-bs-target="#addScreeningModal">
                <i class="bi bi-plus-circle"></i> Schedule New Screening
            </button>
        </div>

        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">Movie</label>
                        <select id="movieFilter" class="form-select">
                            <option value="">All Movies</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">From Date</label>
                        <input type="date" id="dateFromFilter" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">To Date</label>
                        <input type="date" id="dateToFilter" class="form-control">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-outline-secondary w-100" onclick="loadScreenings()">
                            <i class="bi bi-search"></i> Filter
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Screenings Table -->
        <div class="card">
            <div class="card-header bg-cinema-primary text-white">
                <h5 class="mb-0"><i class="bi bi-list-ul"></i> Scheduled Screenings</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover admin-table mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Movie</th>
                                <th>Hall</th>
                                <th>Start Time</th>
                                <th>End Time</th>
                                <th>Price</th>
                                <th>Available Seats</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="screeningsTableBody">
                            <tr>
                                <td colspan="9" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <nav id="paginationNav">
                    <!-- Pagination will be inserted here -->
                </nav>
            </div>
        </div>
    </main>

    <!-- Add Screening Modal -->
    <div class="modal fade" id="addScreeningModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-cinema-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Schedule New Screening</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="addScreeningFeedback" class="alert alert-danger d-none" role="alert"></div>
                    <form id="addScreeningForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Movie *</label>
                                <select class="form-select" id="addMovieId" name="movieId" required>
                                    <option value="">Select Movie</option>
                                </select>
                                <div class="invalid-feedback" data-field-feedback="movieId"></div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Hall *</label>
                                <select class="form-select" id="addHallId" name="hallId" required>
                                    <option value="">Select Hall</option>
                                </select>
                                <div class="invalid-feedback" data-field-feedback="hallId"></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Start Date & Time *</label>
                                <input type="datetime-local" class="form-control" id="addStartTime" name="startTime" required>
                                <div class="invalid-feedback" data-field-feedback="startTime"></div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Base Price *</label>
                                <input type="number" class="form-control" id="addBasePrice" name="basePrice" required min="0.01" step="0.01">
                                <div class="invalid-feedback" data-field-feedback="basePrice"></div>
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> End time will be calculated automatically based on movie duration.
                            The system will validate for time conflicts with other screenings in the same hall.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-cinema" onclick="addScreening()">
                        <i class="bi bi-save"></i> Schedule Screening
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Screening Modal -->
    <div class="modal fade" id="editScreeningModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-cinema-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-pencil"></i> Edit Screening</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="editScreeningFeedback" class="alert alert-danger d-none" role="alert"></div>
                    <form id="editScreeningForm">
                        <input type="hidden" id="editId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Movie *</label>
                                <select class="form-select" id="editMovieId" name="movieId" required>
                                    <option value="">Select Movie</option>
                                </select>
                                <div class="invalid-feedback" data-field-feedback="movieId"></div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Hall *</label>
                                <select class="form-select" id="editHallId" name="hallId" required>
                                    <option value="">Select Hall</option>
                                </select>
                                <div class="invalid-feedback" data-field-feedback="hallId"></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Start Date & Time *</label>
                                <input type="datetime-local" class="form-control" id="editStartTime" name="startTime" required>
                                <div class="invalid-feedback" data-field-feedback="startTime"></div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Base Price *</label>
                                <input type="number" class="form-control" id="editBasePrice" name="basePrice" required min="0.01" step="0.01">
                                <div class="invalid-feedback" data-field-feedback="basePrice"></div>
                            </div>
                        </div>
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> Changing screening time may affect existing bookings.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-cinema" onclick="updateScreening()">
                        <i class="bi bi-save"></i> Update Screening
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="~{fragments/footer :: footer}"></div>

    <!-- Bootstrap JS Bundle (loaded before page scripts) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let currentPage = 0;
        const pageSize = 15;
        let movies = [];
        let halls = [];
        const feedback = window.AppFeedback || null;
        const addScreeningForm = document.getElementById('addScreeningForm');
        const editScreeningForm = document.getElementById('editScreeningForm');
        const addScreeningFeedback = document.getElementById('addScreeningFeedback');
        const editScreeningFeedback = document.getElementById('editScreeningFeedback');
        // Utility functions for modals
        function showBsModal(modalId) {
            const modalEl = document.getElementById(modalId);
            if (typeof bootstrap !== 'undefined' && modalEl) {
                const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                modal.show();
            }
        }

        function hideBsModal(modalId) {
            const modalEl = document.getElementById(modalId);
            if (typeof bootstrap !== 'undefined' && modalEl) {
                const modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) modal.hide();
            }
        }
        async function loadDropdownData() {
            await Promise.all([loadMovieOptions(), loadHallOptions()]);
        }

        async function loadMovieOptions() {
            try {
                const response = await fetch('/api/v1/movies?page=0&size=1000');
                if (!response.ok) {
                    const error = await parseApiError(response, 'Failed to load movies.');
                    throw error;
                }
                const data = await response.json();
                movies = data.content || [];
                populateMovieDropdowns();
            } catch (error) {
                console.error('Error loading movies:', error);
                showToast('error', 'Unable to load movies', error?.message || 'Movie list is unavailable right now.');
            }
        }

        async function loadHallOptions() {
            try {
                const response = await fetch('/api/v1/halls?page=0&size=100');
                if (!response.ok) {
                    const error = await parseApiError(response, 'Failed to load halls.');
                    throw error;
                }
                const data = await response.json();
                halls = data.content || [];
                populateHallDropdowns();
            } catch (error) {
                console.error('Error loading halls:', error);
                showToast('error', 'Unable to load halls', error?.message || 'Hall list is unavailable right now.');
            }
        }

        function populateMovieDropdowns() {
            const addSelect = document.getElementById('addMovieId');
            const editSelect = document.getElementById('editMovieId');
            const filterSelect = document.getElementById('movieFilter');
            
            const options = movies.map(m => `<option value="${m.id}">${m.title} (${m.genre})</option>`).join('');
            addSelect.innerHTML += options;
            editSelect.innerHTML += options;
            filterSelect.innerHTML += options;
        }

        function populateHallDropdowns() {
            const addSelect = document.getElementById('addHallId');
            const editSelect = document.getElementById('editHallId');
            
            const options = halls.map(h => `<option value="${h.id}">${h.name} (${h.capacity} seats)</option>`).join('');
            addSelect.innerHTML += options;
            editSelect.innerHTML += options;
        }

        async function loadScreenings(page = 0) {
            currentPage = page;
            const movieId = document.getElementById('movieFilter').value;
            const dateFrom = document.getElementById('dateFromFilter').value;
            const dateTo = document.getElementById('dateToFilter').value;
            
            let url = `/api/v1/screenings?page=${page}&size=${pageSize}&sort=startTime,desc`;
            if (movieId) url += `&movieId=${movieId}`;
            if (dateFrom) url += `&startDate=${dateFrom}T00:00:00`;
            if (dateTo) url += `&endDate=${dateTo}T23:59:59`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    const error = await parseApiError(response, 'Failed to load screenings.');
                    throw error;
                }
                const data = await response.json();
                renderScreeningsTable(data.content);
                renderPagination(data);
            } catch (error) {
                console.error('Error loading screenings:', error);
                document.getElementById('screeningsTableBody').innerHTML = 
                    '<tr><td colspan="9" class="text-center text-danger py-4">Failed to load screenings</td></tr>';
                showToast('error', 'Unable to load screenings', error?.message || 'Please adjust your filters and try again.');
            }
        }

        function renderScreeningsTable(screenings) {
            const tbody = document.getElementById('screeningsTableBody');
            if (screenings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center py-4">No screenings found</td></tr>';
                return;
            }

            tbody.innerHTML = screenings.map(screening => {
                const startTime = new Date(screening.startTime);
                const endTime = new Date(screening.endTime);
                const now = new Date();
                const isPast = startTime < now;
                const statusBadge = isPast ? 
                    '<span class="badge bg-secondary">Past</span>' : 
                    '<span class="badge bg-success">Upcoming</span>';

                return `
                    <tr>
                        <td>${screening.id}</td>
                        <td><strong>${screening.movieTitle || 'N/A'}</strong></td>
                        <td>${screening.hallName || 'N/A'}</td>
                        <td>${formatDateTime(startTime)}</td>
                        <td>${formatDateTime(endTime)}</td>
                        <td>$${screening.basePrice?.toFixed(2) || '0.00'}</td>
                        <td><span class="badge bg-info">${screening.availableSeats || 0}</span></td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editScreening(${screening.id})" ${isPast ? 'disabled' : ''}>
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteScreening(${screening.id})" ${isPast ? 'disabled' : ''}>
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function formatDateTime(date) {
            const options = { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            };
            return date.toLocaleDateString('en-US', options);
        }

        function renderPagination(data) {
            const nav = document.getElementById('paginationNav');
            if (data.totalPages <= 1) {
                nav.innerHTML = '';
                return;
            }

            let html = '<ul class="pagination pagination-sm mb-0 justify-content-center">';
            
            html += `<li class="page-item ${data.first ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadScreenings(${currentPage - 1}); return false;">Previous</a>
            </li>`;

            for (let i = 0; i < data.totalPages; i++) {
                if (i === 0 || i === data.totalPages - 1 || Math.abs(i - currentPage) <= 2) {
                    html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadScreenings(${i}); return false;">${i + 1}</a>
                    </li>`;
                } else if (Math.abs(i - currentPage) === 3) {
                    html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }

            html += `<li class="page-item ${data.last ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadScreenings(${currentPage + 1}); return false;">Next</a>
            </li>`;
            
            html += '</ul>';
            nav.innerHTML = html;
        }

        function buildScreeningPayload(form) {
            const formData = new FormData(form);
            return {
                movieId: toNumber(formData.get('movieId')),
                hallId: toNumber(formData.get('hallId')),
                startTime: formData.get('startTime'),
                basePrice: toFloat(formData.get('basePrice'))
            };
        }

        function validateScreeningPayload(payload) {
            const errors = {};
            if (!payload.movieId) errors.movieId = 'Movie is required';
            if (!payload.hallId) errors.hallId = 'Hall is required';
            if (!payload.startTime) errors.startTime = 'Start time is required';
            if (payload.basePrice === null || payload.basePrice <= 0) {
                errors.basePrice = 'Base price must be greater than 0';
            }
            return errors;
        }

        function toNumber(value) {
            const num = Number(value);
            return Number.isFinite(num) ? num : null;
        }

        function toFloat(value) {
            if (value === null || value === undefined || value === '') {
                return null;
            }
            const num = parseFloat(value);
            return Number.isFinite(num) ? num : null;
        }

        async function parseApiError(response, fallbackMessage) {
            if (feedback?.parseErrorResponse) {
                const detail = await feedback.parseErrorResponse(response);
                if (feedback?.createError) {
                    return feedback.createError(detail);
                }
                const err = new Error(detail.message || fallbackMessage);
                err.errors = detail.errors;
                return err;
            }
            const text = await response.text();
            return new Error(text || fallbackMessage);
        }

        function handleFormError(form, container, error, fallbackMessage) {
            if (!form || !container) return;
            if (error?.errors && feedback?.setFieldErrors) {
                feedback.setFieldErrors(form, error.errors);
            }
            showFormErrors(container, error?.message || fallbackMessage, error?.errors);
        }

        function showFormErrors(container, message, validation) {
            if (!container) return;
            container.replaceChildren();
            const summary = document.createElement('div');
            summary.textContent = message;
            container.appendChild(summary);
            const details = buildValidationList(validation);
            if (details && details.length) {
                const list = document.createElement('ul');
                list.className = 'mb-0 mt-2 small';
                details.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    list.appendChild(li);
                });
                container.appendChild(list);
            }
            container.classList.remove('d-none');
        }

        function hideFormErrors(container) {
            if (!container) return;
            container.classList.add('d-none');
            container.replaceChildren();
        }

        function buildValidationList(errors) {
            if (!errors) return null;
            if (feedback?.validationList) {
                return feedback.validationList(errors);
            }
            return Object.entries(errors).map(([field, message]) => `${formatField(field)}: ${message}`);
        }

        function formatField(field) {
            if (!field) return 'Field';
            return field
                .replace(/([A-Z])/g, ' $1')
                .replace(/[_-]+/g, ' ')
                .replace(/^./, ch => ch.toUpperCase())
                .trim();
        }

        function showToast(type, title, message) {
            const handler = feedback?.[type] || feedback?.info;
            if (typeof handler === 'function') {
                handler(title, message);
            }
        }

        async function addScreening() {
            if (!addScreeningForm) return;
            feedback?.clearFieldErrors?.(addScreeningForm);
            hideFormErrors(addScreeningFeedback);
            const screeningData = buildScreeningPayload(addScreeningForm);
            const clientErrors = validateScreeningPayload(screeningData);
            if (Object.keys(clientErrors).length) {
                feedback?.setFieldErrors?.(addScreeningForm, clientErrors);
                showFormErrors(addScreeningFeedback, 'Please fix the highlighted fields.', clientErrors);
                showToast('warning', 'Missing information', 'Fill in the required screening details before saving.');
                return;
            }

            try {
                const response = await fetch('/api/v1/screenings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(screeningData)
                });
                if (!response.ok) {
                    const error = await parseApiError(response, 'Failed to schedule screening.');
                    handleFormError(addScreeningForm, addScreeningFeedback, error, 'Failed to schedule screening.');
                    throw error;
                }
                hideBsModal('addScreeningModal');
                addScreeningForm.reset();
                showToast('success', 'Screening scheduled', 'The screening was added successfully.');
                loadScreenings(currentPage);
            } catch (error) {
                console.error('Error:', error);
                if (!error?.errors) {
                    showFormErrors(addScreeningFeedback, error?.message || 'Failed to schedule screening.');
                    showToast('error', 'Failed to schedule screening', error?.message || 'Please try again.');
                }
            }
        }

        async function editScreening(id) {
            feedback?.clearFieldErrors?.(editScreeningForm);
            hideFormErrors(editScreeningFeedback);
            try {
                const response = await fetch(`/api/v1/screenings/${id}`);
                if (!response.ok) {
                    const error = await parseApiError(response, 'Failed to load screening details.');
                    throw error;
                }
                const screening = await response.json();
                document.getElementById('editId').value = screening.id;
                document.getElementById('editMovieId').value = screening.movieId;
                document.getElementById('editHallId').value = screening.hallId;
                document.getElementById('editStartTime').value = (screening.startTime || '').substring(0, 16);
                document.getElementById('editBasePrice').value = screening.basePrice;
                showBsModal('editScreeningModal');
            } catch (error) {
                console.error('Error:', error);
                showToast('error', 'Unable to load screening', error?.message || 'Please try again.');
            }
        }

        async function updateScreening() {
            if (!editScreeningForm) return;
            const id = document.getElementById('editId').value;
            feedback?.clearFieldErrors?.(editScreeningForm);
            hideFormErrors(editScreeningFeedback);
            const screeningData = buildScreeningPayload(editScreeningForm);
            const clientErrors = validateScreeningPayload(screeningData);
            if (Object.keys(clientErrors).length) {
                feedback?.setFieldErrors?.(editScreeningForm, clientErrors);
                showFormErrors(editScreeningFeedback, 'Please fix the highlighted fields.', clientErrors);
                showToast('warning', 'Missing information', 'Fill in the required screening details before saving.');
                return;
            }

            try {
                const response = await fetch(`/api/v1/screenings/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(screeningData)
                });
                if (!response.ok) {
                    const error = await parseApiError(response, 'Failed to update screening.');
                    handleFormError(editScreeningForm, editScreeningFeedback, error, 'Failed to update screening.');
                    throw error;
                }
                hideBsModal('editScreeningModal');
                showToast('success', 'Screening updated', 'The screening was updated successfully.');
                loadScreenings(currentPage);
            } catch (error) {
                console.error('Error:', error);
                if (!error?.errors) {
                    showFormErrors(editScreeningFeedback, error?.message || 'Failed to update screening.');
                    showToast('error', 'Failed to update screening', error?.message || 'Please try again.');
                }
            }
        }

        async function deleteScreening(id) {
            if (!confirm('Are you sure you want to delete this screening? This action cannot be undone.')) return;

            try {
                const response = await fetch(`/api/v1/screenings/${id}`, { method: 'DELETE' });
                if (!response.ok) {
                    const error = await parseApiError(response, 'Failed to delete screening.');
                    throw error;
                }
                showToast('success', 'Screening deleted', 'The screening has been removed.');
                loadScreenings(currentPage);
            } catch (error) {
                console.error('Error:', error);
                showToast('error', 'Failed to delete screening', error?.message || 'It may have existing bookings.');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadDropdownData();
            loadScreenings();
            
            // Set minimum date to today for date inputs
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateFromFilter').setAttribute('min', today);
            document.getElementById('dateToFilter').setAttribute('min', today);
            
            // Add event listeners for screening filters
            document.getElementById('movieFilter').addEventListener('change', () => loadScreenings(0));
            document.getElementById('dateFromFilter').addEventListener('change', () => loadScreenings(0));
            document.getElementById('dateToFilter').addEventListener('change', () => loadScreenings(0));
            
            // Set minimum datetime to now for screening times
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('addStartTime').setAttribute('min', now.toISOString().slice(0, 16));
            document.getElementById('editStartTime').setAttribute('min', now.toISOString().slice(0, 16));
        });
    </script>
</body>
</html>
